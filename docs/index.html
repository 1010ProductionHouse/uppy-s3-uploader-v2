<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1010 Production House - File Uploader</title>
    
    <!-- Tailwind CSS for a modern, mobile-friendly design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }
        .uppy-Root {
            font-family: 'Inter', sans-serif;
        }
    </style>
    
    <!-- Uppy CSS and JS from CDN -->
    <link href="https://releases.transloadit.com/uppy/v3.21.0/uppy.min.css" rel="stylesheet">
    <script src="https://releases.transloadit.com/uppy/v3.21.0/uppy.min.js"></script>

    <!-- AWS SDK for JavaScript from CDN -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1120.0.min.js"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="max-w-4xl w-full bg-gray-800 rounded-lg shadow-xl p-8 space-y-6">
        <header class="text-center">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-blue-500">
                1010 Production House
            </h1>
            <h2 class="mt-2 text-xl font-medium text-gray-300">Member Footage Uploader</h2>
            <p class="mt-4 text-gray-400">
                Please upload your files securely below. You can upload multiple files at once.
            </p>
        </header>

        <!-- Uppy Dashboard will be injected here -->
        <div id="uppy-dashboard" class="border-2 border-dashed border-gray-600 rounded-lg p-4"></div>

        <div id="upload-status" class="mt-4 text-center"></div>
    </div>

    <script>
        // Set up the AWS SDK configuration
        AWS.config.update({
            region: 'us-west-2',
        });

        // --- IMPORTANT: CONFIGURE YOUR VALUES HERE ---
        const IDENTITY_POOL_ID = 'us-west-2:870a65b0-5406-4545-aa87-369e41b7bbf8';
        const S3_BUCKET_NAME = 'edit-in-cloud-media-transfer';
        const API_GATEWAY_URL = 'https://wituigrjpl.execute-api.us-west-2.amazonaws.com/prod';

        // Placeholder for the NEXUDUS member ID.
        const NEXUDUS_MEMBER_ID = 'member-12345';
        
        // This is where Uppy will put the uploaded files in your S3 bucket.
        const S3_KEY_PREFIX = `uploads/${NEXUDUS_MEMBER_ID}/`;
        
        const uppy = new Uppy.Uppy({
            debug: true,
            restrictions: {
                maxFileSize: 5000000000,
                maxNumberOfFiles: 10,
                minNumberOfFiles: 1,
            },
        })
        .use(Uppy.Dashboard, {
            target: '#uppy-dashboard',
            inline: true,
            showProgressDetails: true,
            proudlyDisplayPoweredByUppy: false,
            note: 'Video files up to 5 GB are supported.',
            theme: 'dark',
        })
        .use(Uppy.XHRUpload, {
            // This is the endpoint that Uppy will make a POST request to.
            // It will call your UPPYS3PRESIGNER Lambda via API Gateway.
            endpoint: API_GATEWAY_URL, 
            method: 'POST',
            formData: true,
            fieldName: 'files[]',
            headers: {
                // Pass the member ID in a custom header for your Lambda to use.
                'X-Uploader-ID': NEXUDUS_MEMBER_ID,
            },
            // The onRequest method is a critical part of the new workflow.
            // It modifies the request before Uppy sends it to S3.
            onRequest: (request) => {
                const { key, uniqueName, filename, contentType } = file.meta;
                const body = {
                    username: NEXUDUS_MEMBER_ID, // Your Lambda function will use this to find the correct folder
                    filename: filename
                };

                // The Lambda function will return a pre-signed URL and key.
                // We'll set the request body here.
                request.body = JSON.stringify(body);
                request.setHeader('Content-Type', 'application/json');
            },
            // The onUploadStarted method is also important.
            // It generates the pre-signed URL and updates the upload request.
            onUploadStarted: async (upload, file) => {
                // This is a new, simplified approach that just gets a presigned URL directly.
                const url = new URL(file.uploadURL);
                const response = await fetch(url, {
                    method: 'PUT',
                    body: file.data,
                    headers: { 'Content-Type': file.data.type }
                });
                if (!response.ok) {
                    throw new Error('Failed to upload file');
                }
            }
        });

        uppy.on('complete', result => {
            const statusDiv = document.getElementById('upload-status');
            if (result.successful.length > 0) {
                statusDiv.innerHTML = `<p class="text-green-400 font-semibold">Upload Complete! ${result.successful.length} file(s) uploaded successfully.</p>`;
            }
            if (result.failed.length > 0) {
                statusDiv.innerHTML += `<p class="text-red-400 font-semibold">Upload Failed for ${result.failed.length} file(s).</p>`;
            }
        });
    </script>
</body>
</html>
